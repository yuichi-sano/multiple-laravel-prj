## ken_allのレコード分割機能概要

* メインメソッド -> ZipCodeFactory->splitRow()
* 分割処理要否の判定 → ZipCodeFactory->needSplit()

### 1. 実装機能の概要

* ken_all内に存在する特定のレコードを分割する
* レコードの属性値のうち分割するのは下記2つの属性値である
    1. 町域名称
    2. 町域名称カナ
* 分割する町域名称にはパターンが複数存在するため、そのパターン別に対応を行う
* 以降は町域名称を例にとって説明し、町域名称カナについては割愛する

#### 1.1. 分割パターン一覧

1. 主・従属パターン ptnMainSub
2. 複数の主パターン ptnMultiMain
3. 連番の主パターン ptnSerialMain
4. 主と複数の住所単位パターンptnMainMultiUnit
5. 主と連続した住所単位パターン ptnMainSerialUnit
6. 主・従属と連続した住所単位パターン ptnMainSubSerialUnit
7. 連続の主と・単一の従属町域パターンptnSerialMainSub

### 2.分割パターン詳細

#### 2.1.主・従属パターン ptnMainSub

* 単一のレコードの下記属性が複数の情報を保持しているもの
    1. 町域属性(インデックス8)

    * `主な町域（従属する町域1、従属する町域2、...従属する町域n）`の形式で記入されている

    2. 町域カナ属性(インデックス5)

    * `主な町域(従属する町域1，従属する町域2，...従属する町域n)`の形式で記入されている
* ken_allには、1と2両方を満たすものと、1のみを満たすものが存在している
* 例：`亀屋町（河原町通荒神口東入、荒神口通河原町東入）`

#### 2.2. 複数の主パターン ptnMultiMain

* `、`区切りで複数の町域を記載しているもの
    1. `主な町域1、主な町域2、... 主な町域n`
* 例：`穴明２２地割、穴明２３地割`

#### 2.3. 連続の主パターン ptnSerialMain

* 複数の連続した町域を、連番の始点と終点の間を`〜`で表現しているもの
    1. `主な町域1〜主な町域5`
* 例：`下前７地割～下前１４地割`

#### 2.4. 主と複数の住所単位パターンptnMainMultiUnit

* 主な町域と、従属した数字のみ町域が列挙されており、かつ末尾に住所区分単位が記載されているもの
    1. `主な町域（1,2丁目）`
* 例：`五橋（１、２丁目）`
* 例2：`上寺島（１６５３、１６６１、１６７８、１６９４番地）`

#### 2.5. 主と連続した住所単位パターン ptnMainSerialUnit

* 主な町域と連続した従属町域が記載されているもの
    1. `主な町域（1〜5丁目）`
* 例：`小田原（４～８丁目）`
* 例2：`猪国（猪位金１～３区）`

#### 2.6. 主・従属と連続した住所単位パターン ptnMainSubSerialUnit

* 主な町域と連続した従属町域とその連続していない従属町域が記載されているもの
    1. `主な町域（1〜5丁目,従属した町域）`
* 例：`位登（猪位金４～７区、清美町）`

#### 2.7. 連続の主と・単一の従属町域パターンptnSerialMainSub

* 主な町域が連続して存在しており、かつ従属した町域が1つだけ存在するもの
* 例：`種市第４６地割～第４９地割（麦沢）`

## 3.分割の対象外

* 複数の町域情報が記載されているレコードでも下記の条件に該当するものは分割処理を行わない
* 条件：人の手で調査が必要なもの

#### 3.1 分割を行わないパターン詳細

1. 連続した主の町域に複数の従属した町域が存在する場合

* 例：`種市第１５地割～第２１地割（鹿糠、小路合、緑町、大久保、高取）`
* どの主の町域がどの従属した町域に紐付いているか不明

2. 連続する町域だが連続の終点が存在しないもの

* 例：`大前（細原２２５９～）`
* この町域が何番まで存在するか不明
* ただしこの町域情報が複数記載された町域の1つであれば分割処理を行う
* 例：`下甑町瀬々野浦（１７００番地～、内川内）`

### 4.分割するレコード内容

* 単一レコード内で分割する情報は町域名称と町域名称カナ属性のみである
* そのため、分割したレコードは、上記2つの属性値以外は同一の値で生成される

#### 4.1.主町域・従属町域パターン

* 従属する町域の数だけ下記のレコードを生成する
    1. 町域属性と町域カナ属性に、主な町域と従属する町域を結合した値を挿入

    * 分割元で町域カナ属性が従属する町域を保持してい場合がある
    * その際は、分割元と同じ値を挿入
* 上記に加えて、主の町域のみの値を挿入したレコードも作成する
* こちらは類似サービスであるzipcloudの仕様を参考にしている
* 例：`亀屋町（河原町通荒神口東入、荒神口通河原町東入）`を分割した場合
    1. `亀屋町`
    2. `亀屋町河原町通荒神口東入`
    3. `亀屋町荒神口通河原町東入`

#### 4.2. 複数の主パターン ptnMultiMain

* 町域の数だけ下記のレコードを生成する
    1. `、`を区切り文字として町域を分割
* 例：`穴明２２地割、穴明２３地割`を分割した場合
    1. `穴明２２地割`
    2. `穴明２３地割`

#### 4.3. 連続の主パターン ptnSerialMain

* 町域の数だけ下記のレコードを生成する
    1. `〜`の前後のに存在する、連番の始点と終点の数値をを生成して1つずつ割り当てる
* 例：`下前７地割～下前１４地割`を分割した場合
    1. `下前７地割`
    2. `下前８地割`
    3. `下前９地割`
    4. `下前１０地割`
    5. `下前１１地割`
    6. `下前１２地割`
    7. `下前１３地割`
    8. `下前１４地割`

#### 4.4. 主と複数の住所単位パターンptnMainMultiUnit

* 従属する町域の数だけ下記のレコードを生成する
    1. 町域属性と町域カナ属性に、主な町域と従属する町域と住所単位を結合した値を挿入
* 例：`上寺島（１６５３、１６６１、１６７８、１６９４番地）`を分割した場合
    1. `上寺島１６５３番地`
    2. `上寺島１６６１番地`
    3. `上寺島１６７８番地`
    4. `上寺島１６７８番地`

#### 4.5. 主と連続した住所単位パターン ptnMainSerialUnit

* 従属する町域の数だけ下記のレコードを生成する
    1. `〜`の前後のに存在する、連番の始点と終点の数値をを生成
    2. 主な町域と生成した数値と住所単位を結合した値を挿入

    * 住所単位は存在しない場合もある
* 例：`猪国（猪位金１～３区）`を分割した場合
    1. `猪国猪位金１区`
    2. `猪国猪位金２区`
    3. `猪国猪位金３区`

#### 4.6. 主・従属と連続した住所単位パターン ptnMainSubSerialUnit

* 従属する町域の数だけ下記のレコードを生成する
    1. 目次4.5.主と連続した住所単位パターンと同一のレコード
    2. 主町域・従属町域パターンと同一の分割規則のレコード

    * 住所単位は存在しない場合もある
* 例：`位登（猪位金４～７区、清美町）`を分割した場合
    1. `猪国猪位金４区`
    2. `猪国猪位金５区`
    3. `猪国猪位金６区`
    4. `猪国猪位金７区`
    5. `位登`
    5. `位登清美町`

#### 2.7. 連続の主と・単一の従属町域パターンptnSerialMainSub

* 主な町域の数だけ下記のレコードを生成する
    1. `〜`の前後のに存在する、連番の始点と終点の数値をを生成
    2. 主な町域と生成した数値と従属を結合した町域を挿入

    * 他パターンでは従属町域のカッコは外すが、このパターンではカッコを外さない
* 例：`種市第４６地割～第４９地割（麦沢）`を分割した場合
    1. `種市第４６地割（麦沢）`
    2. `種市第４７地割（麦沢）`
    3. `種市第４８地割（麦沢）`
    4. `種市第４９地割（麦沢）`

#### 2.3. 連続の主パターン ptnSerialMain

### 5.実装方法

* 大まかに下記の流れでレコードを分割する

1. レコードの分割要否を判定、分割が必要と判断された場合は移行の工程へ進む
2. 分割メソッド呼び出し needSplit()
3. 分割パターンを解析 -> analyzeSplitPattern()

* analyzeSplitPatternはそれぞれの町域分割パターンを判定するメソッドを順番に呼び出す

4. それぞれのパターンに応じた町域分割メソッドを呼び出す -> split〇〇()
5. 分割された町域の分だけ、レコードのテンプレートを生成 -> generateTemplateRow()
6. 生成されたテンプレートに一件づつ分割した町域情報を登録する
